<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout(~{::title}, ~{::section}, ~{::headResources})}">
<head>
    <title>카메라 관리 | E-N-C 안전 관제</title>
    <th:block th:fragment="headResources">
        <link rel="stylesheet" th:href="@{/css/cameras.css}">
        <script th:src="@{/js/camera-map.js}" defer></script>
        <th:block th:if="${naverMapClientId}">
            <script th:src="@{'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=' + ${naverMapClientId} + '&submodules=geocoder&callback=initCameraMap'}"
                    defer></script>
        </th:block>
    </th:block>
</head>
<body>
<section class="camera-management-page">
    <div class="camera-surface">
        <header class="page-header">
            <div class="page-header__meta">
                <p class="breadcrumbs">관제 &gt; 카메라 관리</p>
                <h1 class="title">카메라 관리</h1>
                <p class="subtitle">RTSP 스트림과 기본 정보를 저장하고, 지도 기반으로 위치를 빠르게 지정하세요.</p>
            </div>
            <div class="page-header__actions">
                <label class="search-field" aria-disabled="true">
                    <input type="search" placeholder="카메라 이름 또는 RTSP 주소 검색" aria-label="카메라 검색" disabled>
                    <span class="search-icon" aria-hidden="true"></span>
                </label>
            </div>
        </header>

        <div class="toast" th:if="${toastMessage}" th:text="${toastMessage}">처리되었습니다.</div>

        <section class="overview-strip" aria-label="카메라 현황 요약" th:if="${summary != null}">
            <article class="card h-pad overview-card">
                <p class="label">전체 카메라</p>
                <p class="value" data-role="total-cameras" th:text="${summary.total} + '대'">0대</p>
                <p class="note"
                   th:text="${#lists.isEmpty(cameras) ? '등록된 카메라가 없습니다.' : '최근 등록: ' + #temporals.format(cameras.get(0).createdAt, 'yyyy-MM-dd HH:mm')}">
                    등록된 카메라가 없습니다.
                </p>
            </article>
            <article class="card h-pad overview-card">
                <p class="label">정상 상태</p>
                <p class="value value--success" data-role="healthy-cameras" th:text="${summary.healthy} + '대'">0대</p>
                <p class="note">상태 값은 추후 자동화 전까지 수동으로 관리됩니다.</p>
            </article>
            <article class="card h-pad overview-card">
                <p class="label">주의 / 오프라인</p>
                <p class="value" data-role="warning-cameras"
                   th:text="|주의 ${summary.warning} · 오프라인 ${summary.offline}|">
                    주의 0 · 오프라인 0
                </p>
                <p class="note">상태 변경 기능은 향후 편집 기능과 함께 제공합니다.</p>
            </article>
        </section>

        <div class="management-stack">
            <article class="card h-pad camera-card camera-list-card" aria-labelledby="camera-list-title">
                <div class="card-head">
                    <div>
                        <h2 id="camera-list-title" class="card-title">등록된 카메라</h2>
                        <p class="panel-subtitle">RTSP 주소와 위치 정보를 확인하고 필요 시 삭제할 수 있습니다.</p>
                    </div>
                </div>

                <div class="card-body">
                    <div class="card-toolbar" role="group" aria-label="카메라 목록 필터">
                        <div class="toolbar-group">
                            <label class="filter-field">
                                <span class="filter-label">상태</span>
                                <select name="statusFilter" aria-label="상태 필터" disabled>
                                    <option value="all" selected>전체</option>
                                </select>
                            </label>
                            <label class="filter-field">
                                <span class="filter-label">정렬</span>
                                <select name="orderBy" aria-label="정렬 기준" disabled>
                                    <option value="recent" selected>최근 등록 순</option>
                                </select>
                            </label>
                        </div>
                        <button type="button" class="btn btn--ghost btn--sm" disabled>필터 준비 중</button>
                    </div>

                    <div class="table-region">
                        <div class="table-wrapper">
                            <div class="table-scroll">
                                <table class="camera-table">
                                    <thead>
                                    <tr>
                                        <th scope="col">카메라명</th>
                                        <th scope="col">주소 / 좌표</th>
                                        <th scope="col">상태</th>
                                        <th scope="col">RTSP 스트림</th>
                                        <th scope="col">작업</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:if="${#lists.isEmpty(cameras)}">
                                        <td colspan="5" class="empty-row">
                                            아직 등록된 카메라가 없습니다. 아래 폼으로 첫 카메라를 추가해 주세요.
                                        </td>
                                    </tr>
                                    <tr th:each="camera : ${cameras}">
                                        <td>
                                            <div class="table-primary-text" th:text="${camera.name}">정문 로비 1번</div>
                                            <div class="table-secondary-text" th:if="${camera.description}"
                                                 th:text="${camera.description}">
                                                출입 상황 모니터링
                                            </div>
                                        </td>
                                        <td>
                                            <div class="table-primary-text"
                                                 th:text="${camera.address != null && !camera.address.isBlank() ? camera.address : '주소 미입력'}">
                                                서울시 강남구 테헤란로 100
                                            </div>
                                            <div class="table-secondary-text"
                                                 th:if="${camera.latitude != null && camera.longitude != null}"
                                                 th:text="|좌표: ${camera.latitude}, ${camera.longitude}|">
                                                좌표: 37.492284, 127.029423
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-chip"
                                                  th:text="${camera.status.displayName}"
                                                  th:classappend="${' status-chip--' + camera.status.name().toLowerCase()}">
                                                정상
                                            </span>
                                        </td>
                                        <td>
                                            <code class="stream-url" th:text="${camera.streamUrl}">rtsp://example/live</code>
                                        </td>
                                        <td>
                                            <form th:action="@{'/cameras/' + ${camera.id} + '/delete'}" method="post"
                                                  onsubmit="return confirm('이 카메라를 삭제할까요?');">
                                                <button type="submit" class="btn btn--danger btn--sm">삭제</button>
                                            </form>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </article>

            <article class="card h-pad camera-card camera-editor-card" aria-labelledby="camera-editor-title">
                <div class="card-head">
                    <div>
                        <h2 id="camera-editor-title" class="card-title">카메라 등록 · 관리</h2>
                        <p class="panel-subtitle">RTSP 주소와 설명을 입력하고, 지도에서 핀을 찍어 위치 정보를 선택하세요.</p>
                    </div>
                </div>

                <div class="card-body">
                    <form id="camera-form" class="camera-form" th:action="@{/cameras}" method="post"
                          th:object="${cameraForm}" novalidate>
                        <div class="form-section">
                            <div class="form-grid">
                                <label class="field">
                                    <span class="field-label">카메라명</span>
                                    <input type="text" th:field="*{name}" placeholder="본관 로비 1번" required>
                                    <span class="field-error" th:if="${#fields.hasErrors('name')}"
                                          th:errors="*{name}">카메라 이름 오류</span>
                                </label>
                                <label class="field">
                                    <span class="field-label">RTSP 스트림 주소</span>
                                    <input type="url" th:field="*{streamUrl}" placeholder="rtsp://example.com/live" required>
                                    <span class="field-error" th:if="${#fields.hasErrors('streamUrl')}"
                                          th:errors="*{streamUrl}">스트림 주소 오류</span>
                                </label>
                            </div>
                            <label class="field">
                                <span class="field-label">카메라 설명</span>
                                <textarea th:field="*{description}" rows="3"
                                          placeholder="출입 상황 모니터링을 위한 카메라입니다."></textarea>
                                <span class="field-error" th:if="${#fields.hasErrors('description')}"
                                      th:errors="*{description}">설명 오류</span>
                            </label>
                        </div>

                        <div class="form-section form-section--location">
                            <div class="location-section">
                                <div class="location-header">
                                    <div>
                                        <h3>주소 및 좌표</h3>
                                        <p>주소 검색으로 지도를 이동하거나, 원하는 위치를 클릭해 좌표와 주소를 자동으로 채우세요.</p>
                                    </div>
                                </div>

                                <div class="map-and-coordinates">
                                    <div class="map-container">
                                        <div id="camera-map"
                                             class="map-canvas"
                                             data-default-lat="37.5665"
                                             data-default-lng="126.9780"
                                             th:data-lat="${cameraForm.latitude}"
                                             th:data-lng="${cameraForm.longitude}">
                                        </div>
                                        <button type="button" class="map-locate-button" data-role="locate-me"
                                                title="현재 위치로 이동" th:if="${naverMapClientId}">
                                            <span aria-hidden="true"></span>
                                            <span class="sr-only">현재 위치로 이동</span>
                                        </button>
                                        <p class="map-hint" data-role="map-status"
                                           th:text="${naverMapClientId} ? '지도를 클릭하면 핀이 추가되고 좌표가 입력됩니다.' : '네이버 지도 API 키가 설정되지 않았습니다. 환경 변수 NAVER_MAP_CLIENT_ID를 지정하세요.'">
                                            지도를 클릭하면 핀이 추가되고 좌표가 입력됩니다.
                                        </p>
                                    </div>
                                    <div class="coordinates-card">
                                        <h4>주소와 좌표</h4>
                                        <label class="field">
                                            <span class="field-label">주소</span>
                                            <div class="address-search__controls">
                                                <input type="text" th:field="*{address}" placeholder="서울시 강남구 테헤란로 100">
                                                <button type="button" class="btn btn--ghost btn--sm" data-role="address-search">
                                                    주소 검색
                                                </button>
                                            </div>
                                            <span class="field-helper">필요 시 주소를 직접 입력하거나 검색 기능을 사용하세요.</span>
                                            <span class="field-error" th:if="${#fields.hasErrors('address')}"
                                                  th:errors="*{address}">주소 오류</span>
                                        </label>
                                        <div class="coordinate-fields">
                                            <label class="field">
                                                <span class="field-label">위도</span>
                                                <input type="number" step="0.000001" th:field="*{latitude}" placeholder="37.566500">
                                                <span class="field-error" th:if="${#fields.hasErrors('latitude')}"
                                                      th:errors="*{latitude}">위도 오류</span>
                                            </label>
                                            <label class="field">
                                                <span class="field-label">경도</span>
                                                <input type="number" step="0.000001" th:field="*{longitude}" placeholder="126.978000">
                                                <span class="field-error" th:if="${#fields.hasErrors('longitude')}"
                                                      th:errors="*{longitude}">경도 오류</span>
                                            </label>
                                        </div>
                                        <p class="helper-text">지도에서 핀을 이동하면 위도/경도가 자동으로 갱신됩니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn--primary">저장</button>
                            <a class="btn btn--ghost" th:href="@{/cameras}">초기화</a>
                        </div>
                    </form>
                </div>
            </article>
        </div>
    </div>
</section>
</body>
</html>

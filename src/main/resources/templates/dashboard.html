<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout :: layout(~{::title}, ~{::section}, ~{::headResources})}">

<head>
    <title>대시보드 | E-N-C 캠퍼스 안전</title>
    <th:block th:fragment="headResources">
        <link rel="stylesheet" th:href="@{/css/dashboard.css}">
        <script th:src="@{/js/dashboard.js}" defer></script>
    </th:block>
</head>

<body>
    <section class="dashboard-page">
        <div class="dashboard-surface">
            <section class="dashboard-header">
                <div class="dashboard-header__meta">
                    <div>
                        <p class="dashboard-header__subtitle">등록된 YouTube Live 상태</p>
                        <h1 class="dashboard-header__title">실시간 상황 대시보드</h1>
                    </div>
                    <div class="dashboard-header__timestamp">
                        <span th:text="${#dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm:ss')} + ' KST 기준'">
                            2025-06-05 14:32:18 KST 기준
                        </span>
                        <span id="training-countdown" class="timestamp__badge timestamp__badge--ai"
                            th:if="${nextTrainingTime}"
                            th:data-next-training-time="${#temporals.formatISO(nextTrainingTime)}">
                            계산 중...
                        </span>
                        <span class="timestamp__badge">페이지 진입 후 자동 새로고침</span>
                    </div>
                </div>
                <div class="summary-strip">
                    <article class="summary-item">
                        <h2>전체 카메라</h2>
                        <p class="summary-value" id="summary-total-cameras"
                            th:text="${dashboardSummary != null ? dashboardSummary.totalCameras() + '대' : '0대'}">0대</p>
                        <p class="summary-note" id="summary-streaming-note"
                            th:text="${dashboardSummary != null ? 'YouTube Live ' + dashboardSummary.streamingCameras() + '대 연결' : '등록된 카메라가 없습니다.'}">
                            등록된 카메라가 없습니다.
                        </p>
                    </article>
                    <article class="summary-item">
                        <h2>위험 경보</h2>
                        <p class="summary-value summary-value--danger" id="summary-danger-cameras"
                            th:text="${dashboardSummary != null ? dashboardSummary.camerasInDanger() + '대' : '0대'}">0대
                        </p>
                        <p class="summary-note">임계치(0.60) 이상 카메라</p>
                    </article>
                    <article class="summary-item">
                        <h2>최근 경보</h2>
                        <p class="summary-value" id="summary-alert-count"
                            th:text="${dashboardSummary != null ? dashboardSummary.recentAnalysisEvents() + '건' : '0건'}">
                            0건</p>
                        <p class="summary-note">최근 30분 기준</p>
                    </article>
                </div>
                <div class="rotation-status" role="status">
                    <div>
                        <p class="rotation-status__title">카메라 선택 모드</p>
                        <p class="rotation-status__note">목록에서 보고 싶은 카메라를 선택하세요 (예시: 자동 순환 30초)</p>
                    </div>
                    <div class="rotation-status__controls">
                        <span class="rotation-indicator rotation-indicator--auto">
                            <span th:text="${primaryCamera != null ? '실시간' : '연결 끊김'}">LIVE</span>
                        </span>
                        <span class="rotation-status__interval"
                            th:text="${primaryCamera != null ? primaryCamera.name() : '재생 가능한 카메라가 없습니다'}">
                            재생 가능한 카메라가 없습니다
                        </span>
                        <div class="rotation-buttons">
                            <a class="rotation-status__action rotation-status__action--mode" th:href="@{/cameras}">카메라
                                등록</a>
                        </div>
                    </div>
                </div>
            </section>

            <div class="dashboard-grid">
                <main class="dashboard-main">
                    <section class="camera-stage" th:attr="data-camera-id=${primaryCamera?.id}">
                        <header class="camera-stage__header">
                            <div>
                                <p class="camera-stage__label">카메라</p>
                                <h2>
                                    <span th:if="${primaryCamera != null}" th:text="${primaryCamera.name()}">중앙로비 9층
                                        출입구</span>
                                    <span th:if="${primaryCamera == null}">재생 가능한 카메라가 없습니다</span>
                                </h2>
                                <p class="camera-stage__location">
                                    <span th:if="${primaryCamera != null}"
                                        th:text="${primaryCamera.location() != null ? primaryCamera.location() : '위치 정보 없음'}">
                                        위치 정보 없음
                                    </span>
                                    <span th:if="${primaryCamera == null}">이 페이지에서 YouTube Live 카메라를 등록해주세요</span>
                                </p>
                            </div>
                            <span class="camera-stage__status"
                                th:text="${primaryCamera != null ? 'YouTube Live' : '연결 끊김'}">OFF</span>
                        </header>
                        <div class="camera-stage__feeds">
                            <figure class="camera-view camera-view--live" aria-label="실시간 스트림">
                                <div class="camera-view__display camera-view__display--media"
                                    th:if="${primaryCamera != null}">
                                    <iframe th:src="${primaryCamera.embedUrl()}" title="YouTube Live"
                                        allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen
                                        loading="lazy"></iframe>
                                </div>
                                <div class="camera-view__display camera-view__display--empty"
                                    th:if="${primaryCamera == null}">
                                    <p>재생 가능한 YouTube Live 카메라가 없습니다.</p>
                                    <a class="btn btn--ghost btn--sm" th:href="@{/cameras}">카메라 등록</a>
                                </div>
                                <figcaption
                                    th:text="${primaryCamera != null ? primaryCamera.name() + ' · 자동 순환 재생' : '등록된 카메라 없음'}">
                                    운영 재생
                                </figcaption>
                            </figure>

                            <figure class="camera-view camera-view--snapshot" aria-label="30초 간격 스냅샷">
                                <div id="snapshot-container" class="camera-view__display">
                                    <img th:if="${latestAnnotatedImagePath}" id="snapshot-image"
                                        th:src="${latestAnnotatedImagePath}" alt="최신 분석 스냅샷">
                                    <div th:unless="${latestAnnotatedImagePath}"
                                        class="camera-view__display--placeholder">
                                        <p>분석 스냅샷이 없습니다.</p>
                                        <span>AI 분석이 완료되면 자동으로 표시됩니다.</span>
                                    </div>
                                </div>
                                <figcaption>최신 분석 스냅샷 (30초마다 갱신)</figcaption>
                            </figure>
                        </div>
                    </section>

                    <div class="summary-grid">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">주간 최고 혼잡 장소 Top 5</h2>
                                <p class="card-subtitle">지난 7일간 가장 높은 혼잡도를 기록한 장소</p>
                            </div>
                            <div class="card-body">
                                <ol class="ranked-list" id="dashboard-hotspotList"></ol>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">가장 예측이 어려운 장소 Top 5</h2>
                                <p class="card-subtitle">혼잡도 변화가 가장 심했던 장소 (변동성 기준)</p>
                            </div>
                            <div class="card-body">
                                <ol class="ranked-list" id="dashboard-volatilityList"></ol>
                            </div>
                        </div>
                    </div>

                    <article class="alerts-panel alerts-panel--wide" aria-labelledby="alerts-title">
                        <div class="alerts-panel__header">
                            <h2 id="alerts-title">최근 알림 (실시간)</h2>
                            <p class="alerts-panel__summary">전체 카메라에서 방금 발생한 경보를 시간순으로 보여줍니다.</p>
                        </div>
                        <ul class="alerts-list" id="dashboard-alerts-list">
                            <li th:each="alert : ${recentAlerts}"
                                th:classappend="${'alerts-item--' + alert.severitySuffix()}" class="alerts-item">
                                <time th:text="${#temporals.format(alert.timestamp(), 'HH:mm:ss')}">00:00:00</time>
                                <div>
                                    <div class="alerts-item__camera">
                                        <strong th:text="${alert.cameraName()}">본관 로비</strong>
                                        <span
                                            th:text="${alert.cameraLocation() != null ? alert.cameraLocation() : '위치 정보 없음'}">위치
                                            정보 없음</span>
                                    </div>
                                    <p th:text="${alert.title()}">알림</p>
                                    <span th:text="${alert.message()}"></span>
                                </div>
                            </li>
                        </ul>
                        <p class="alerts-panel__summary" id="dashboard-alerts-empty" style="margin-top: 1rem;"
                            th:hidden="${!#lists.isEmpty(recentAlerts)}">
                            아직 생성된 경보가 없습니다. AI 분석이 완료되면 자동으로 채워집니다.
                        </p>
                    </article>

                </main>

                <aside class="dashboard-sidebar">
                    <section class="camera-list-panel">
                        <h2 class="camera-list-panel__title">전체 카메라</h2>
                        <ul class="camera-list">
                            <li class="camera-list__item camera-list__item--empty"
                                th:if="${#lists.isEmpty(sidebarCameras)}">
                                등록된 카메라가 없습니다.
                            </li>
                            <li th:each="camera : ${sidebarCameras}" class="camera-list__item"
                                th:classappend="${primaryCamera != null and primaryCamera.id() == camera.id()} ? ' camera-list__item--active' : ''"
                                th:attr="data-camera-id=${camera.id()}, data-level=${camera.level().name()}">
                                <a class="camera-list__link" th:href="@{/(cameraId=${camera.id()})}">
                                    <div class="camera-list__meta">
                                        <span class="camera-list__name" th:text="${camera.name()}">본관 로비</span>
                                        <span class="camera-list__location"
                                            th:text="${camera.location() != null ? camera.location() : '위치 정보 없음'}">위치
                                            정보 없음</span>
                                    </div>
                                    <!-- PENDING Status Chip Logic -->
                                    <th:block
                                        th:if="${camera.trainingStatus == T(com.github.jorepong.safetycctv.camera.TrainingStatus).PENDING}">
                                        <span class="chip chip--sm chip--info">학습중</span>
                                    </th:block>
                                    <!-- Other Status Chip Logic -->
                                    <th:block
                                        th:unless="${camera.trainingStatus == T(com.github.jorepong.safetycctv.camera.TrainingStatus).PENDING}">
                                        <span class="chip chip--sm" th:classappend="${'chip--' + camera.level().tone()}"
                                            th:text="${camera.level().label()}">Status</span>
                                    </th:block>
                                </a>
                            </li>
                        </ul>
                    </section>

                    <div class="camera-details-group">
                        <section class="info-panel" th:if="${primaryCameraAnalytics != null}"
                            th:attr="data-level=${primaryCameraAnalytics.level().name()}, data-duration-seconds=${primaryCameraAnalytics.timeInDangerSeconds()}, data-danger-since=${primaryCameraAnalytics.timeInDangerSince() != null ? #temporals.format(primaryCameraAnalytics.timeInDangerSince(), 'yyyy-MM-dd''T''HH:mm:ss') : ''}">
                            <h3 class="info-panel__title">종합 분석</h3>
                            <div class="info-panel__body">
                                <div class="camera-tags">
                                    <div class="chip-group">
                                        <th:block
                                            th:if="${primaryCameraAnalytics.trainingStatus() == T(com.github.jorepong.safetycctv.camera.TrainingStatus).PENDING}">
                                            <span class="chip chip--info">최근 학습 진행 중</span>
                                        </th:block>
                                        <th:block
                                            th:unless="${primaryCameraAnalytics.trainingStatus() == T(com.github.jorepong.safetycctv.camera.TrainingStatus).PENDING}">
                                            <span class="chip" id="panel-level-chip"
                                                th:classappend="${' chip--' + primaryCameraAnalytics.level().tone()}"
                                                th:text="${primaryCameraAnalytics.level().label()}">상태</span>
                                            <span class="chip-duration" id="panel-duration-chip"
                                                th:classappend="${primaryCameraAnalytics.level() != T(com.github.jorepong.safetycctv.analysis.CongestionLevel).DANGER ? ' chip-duration--hidden' : ''}"
                                                th:text="${'Duration ' + primaryCameraAnalytics.timeInDangerFormatted()}">
                                                Duration 00:00:00
                                            </span>
                                            <span class="chip chip--ai" id="panel-eta-chip"
                                                th:classappend="${primaryCameraAnalytics.level() == T(com.github.jorepong.safetycctv.analysis.CongestionLevel).DANGER ? ' chip--hidden' : ''}"
                                                th:text="${primaryCameraAnalytics.etaMessage()}">
                                                예상 시간 정보 없음
                                            </span>
                                        </th:block>
                                    </div>
                                </div>
                                <dl class="camera-metrics">
                                    <th:block
                                        th:if="${primaryCameraAnalytics.trainingStatus() == T(com.github.jorepong.safetycctv.camera.TrainingStatus).PENDING}">
                                        <div class="camera-metrics__placeholder">
                                            <p>학습이 곧 완료됩니다.<br>여기에 지표가 표시됩니다.</p>
                                        </div>
                                    </th:block>
                                    <th:block
                                        th:unless="${primaryCameraAnalytics.trainingStatus() == T(com.github.jorepong.safetycctv.camera.TrainingStatus).PENDING}">
                                        <div class="camera-metrics__main">
                                            <dt>밀집도</dt>
                                            <dd>
                                                <span class="metric-value" id="panel-density"
                                                    th:text="${primaryCameraAnalytics.latestDensity() != null ? #numbers.formatDecimal(primaryCameraAnalytics.latestDensity(), 1, 2) : '--'}">--</span>
                                                <span class="metric-note" id="panel-density-time"
                                                    th:text="${primaryCameraAnalytics.latestTimestamp() != null ? #temporals.format(primaryCameraAnalytics.latestTimestamp(), 'HH:mm:ss') : '데이터 없음'}">
                                                    데이터 없음
                                                </span>
                                            </dd>
                                        </div>
                                        <div class="camera-metrics__sub">
                                            <div>
                                                <dt>밀집도 추세</dt>
                                                <dd>
                                                    <span id="panel-roc" class="metric-value neutral">--</span>
                                                    <span id="panel-roc-empty" class="metric-value neutral"
                                                        hidden>--</span>
                                                </dd>
                                            </div>
                                        </div>
                                    </th:block>
                                </dl>
                            </div>
                        </section>

                        <div class="info-panel-placeholder"
                            th:if="${primaryCamera == null or primaryCameraAnalytics == null}">
                            <p>카메라를 선택하거나<br>분석 데이터 로딩을 기다려주세요.</p>
                        </div>
                    </div>

                    <article class="alert-trend alert-trend--wide" aria-labelledby="trend-title">
                        <h2 id="trend-title">시간별 알림 추세</h2>
                        <div class="alert-trend__bars" id="alert-trend-bars">
                            <div class="alert-trend__bar-item"
                                th:each="point : ${alertTrend != null ? alertTrend.points : {}}">
                                <span class="alert-trend__bar"
                                    th:style="'height:' + (${alertTrend != null && alertTrend.maxCount > 0 ? (point.count * 100 / alertTrend.maxCount) : 0}) + '%;'"
                                    th:title="${point.hour} + '시 ' + ${point.count} + '건'"></span>
                                <span class="alert-trend__label"
                                    th:text="${#numbers.formatInteger(point.hour, 2)}">00</span>
                            </div>
                        </div>
                        <p class="alert-trend__note" id="alert-trend-note"
                            th:text="${alertTrend != null and !alertTrend.points.isEmpty()} ? '지난 12시간 동안의 시간별 알림 건수' : '지난 12시간 동안 감지된 알림이 없습니다.'">
                            지난 12시간 동안 감지된 알림이 없습니다.
                        </p>
                    </article>

                </aside>
            </div>
        </div>
    </section>

</body>

</html>